<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Flow Chart</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="jquery-3.2.1.min.js"></script>
    <script
      src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
      integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
      crossorigin="anonymous"
    ></script>
    <link href="jquery-ui.min.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
      @import url("https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap");

      #container {
        display: inline-block;
        margin: 0;
        width: 100%;
        position: relative;
        font-family: "Roboto", sans-serif;
      }

      #container svg {
        position: absolute;
      }

      #container .hline {
        stroke: #aaa;
        stroke-width: 1;
        stroke-dasharray: 5, 5;
      }

      #container .tline {
        stroke: #aaa;
        stroke-width: 1;
        stroke-dasharray: 5, 5;
      }

      #container .thead {
        text-anchor: end;
        font-size: 11px;
      }

      #container .thead2 {
        text-anchor: start;
        font-size: 11px;
      }

      #container .box {
        fill-opacity: 0.8;
      }

      #container .btext {
        font-size: 14px;
        fill: #000;
        font-weight: bold;
      }

      #container .btext2 {
        font-size: 12px;
        fill: #555;
      }

      #container .btext2 .active {
        fill: #f00;
      }

      #container .box-3.btext {
        font-size: 13px;
      }

      #container .connection {
        fill: none;
        stroke: #aaa;
        stroke-width: 2;
      }

      #container .connection.active {
        stroke-width: 5;
      }

      #container .tooltip {
        position: absolute;
        padding: 5px 10px;
        border-radius: 4px;
        pointer-events: none;
        background: #555;
        color: #fff;
        font-size: 12px;
      }

      .menu-logo {
        vertical-align: middle;
      }

      .box-menu-tooltip,
      .legend-tooltip,
      .popup {
        position: fixed;
        top: 40px;
        right: 0;
        bottom: auto;
        left: auto;
        max-height: 90%;
        overflow-y: scroll;
        background: #fff;
        z-index: 999;
        font-size: 12px;
      }

      .box-menu-tooltip > div,
      .legend-tooltip > div,
      .popup > div {
        width: 600px;
        padding: 10px;
        border: 1px solid #aaa;
        margin: 10px;
        position: relative;
      }

      .box-menu-tooltip > div {
        width: 400px;
      }

      .box-menu-tooltip > div > a.close .legend-tooltip > div > a.close,
      .popup > div > a.close {
        position: absolute;
        right: 10px;
        top: 10px;
      }

      .popup > div > a.comment {
        position: absolute;
        right: 10px;
        top: 30px;
      }

      .popup > div > label {
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 5px;
        display: block;
        padding-right: 50px;
      }

      .popup > div > label.prop {
        cursor: pointer;
        color: #0057e7;
      }

      #box-menu-close-btn {
        cursor: pointer;
        fill: #0057e7;
        text-decoration: underline;
        font-size: 12px;
      }

      .greyed {
        filter: grayscale(100%);
        -moz-filter: grayscale(100%);
        -webkit-filter: grayscale(100%);
        cursor: default;
      }

      .menu-legend > div > table,
      .popup > div > table {
        border-spacing: 0;
        border-collapse: collapse;
        width: 100%;
      }

      .legend-header {
        width: 30%;
        font-weight: bold;
      }

      .popup table.top {
        margin-bottom: 20px;
      }

      .menu-legend {
        font-size: 10px;
      }

      .menu-legend table td {
        padding-top: 4px;
        vertical-align: top;
      }

      .popup table.top td {
        width: 50%;
        padding-top: 10px;
        vertical-align: top;
      }

      .popup table.bottom th,
      .popup table.bottom td {
        text-align: left;
        width: 25%;
        padding: 2px 5px;
      }

      .popup table.bottom .title {
        padding-top: 5px;
      }

      .popup table.bottom .title td {
        background: #ddd;
      }

      .ui-slider-horizontal {
        height: 0.4em;
      }

      .ui-slider .ui-slider-handle {
        height: 0.8em;
        width: 0.8em;
      }

      #menu-button {
        width: 28px;
        height: 22px;
      }

      .buttons {
        position: fixed;
        top: 114px;
        left: 40px;
        width: 138px;
        z-index: 10;
      }

      .buttons2 > button,
      .buttons > .button-rows button {
        width: 58px;
        height: 28px;
        margin-right: 4px;
        margin-bottom: 4px;
      }

      .buttons2 {
        position: fixed;
        top: 526px;
        left: 25px;
        width: 210px;
        z-index: 10;
      }

      .top-bar {
        position: absolute;
        top: 10px;
        left: 9px;
      }

      .menu {
        position: absolute;
        top: 1px;
        left: 1px;
      }

      .menu-contents {
        position: fixed;
        top: 96px;
        left: 100px;
        width: 50px;
        z-index: 10;
        background: #fafafa;
      }

      .popup-comment {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 1000;
      }

      .popup-comment-bg {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .popup-comment > div {
        margin: 50px auto 0;
        background: #fff;
        height: 240px;
        width: 400px;
        padding: 10px;
      }

      .popup-comment textarea {
        width: 360px;
        resize: none;
        height: 175px;
        margin: 20px;
        box-sizing: border-box;
        padding: 10px;
        font-family: "Roboto", sans-serif;
        line-height: 1.15;
      }

      .popup-comment a {
        font-size: 13px;
        float: right;
        margin-left: 10px;
      }

      .custom-button {
        font-size: 0.7em;
        font-family: "Roboto", sans-serif;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;
      }

      .box-menu-svg {
      }
      .ui-slider {
        pointer-events: auto;
      }
      .ui-slider-handle {
        pointer-events: auto;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
  </body>

  <script>
    // Need to change these for the toolbar images.
    var filePath1 =
      "https://gist.githubusercontent.com/WaydeHerman/0f545ecfef7761ec51d3e2bcbb8303a2/raw/aae8e4adf3adbc1462d36f24179d9694d9ef83ab/Chase-Bank-Logos-cut.png";
    var filePath2 =
      "https://gist.githubusercontent.com/WaydeHerman/0f545ecfef7761ec51d3e2bcbb8303a2/raw/aae8e4adf3adbc1462d36f24179d9694d9ef83ab/0.jpeg";
    /*

      Functions:
      - placed at the top for scope reasons.

      */
    var ft = 864e5;
    var menuReveal = 0;
    var researchModeActive = 0;
    var researchModeWidth = 600;

    function blink() {
      d3.selectAll(".comment-circle")
        .transition()
        .duration(1000)
        .style("fill", "yellow")
        .transition()
        .duration(1000)
        .style("fill", "white")
        .on("end", blink);
    }

    function formatDate(entry) {
      var entryDate = new Date(entry);
      if (entryDate.getMonth() + 1 < 10) {
        var entryMonth = "0" + (entryDate.getMonth() + 1);
      } else {
        var entryMonth = entryDate.getMonth() + 1;
      }

      if (entryDate.getUTCDate() < 10) {
        var entryDay = "0" + entryDate.getUTCDate();
      } else {
        var entryDay = entryDate.getUTCDate();
      }

      return entryDate.getUTCFullYear() + "-" + entryMonth + "-" + entryDay;
    }

    function v(n) {
      var t = new Date(n).toUTCString();
      return t
        .split(" ")
        .slice(1, 4)
        .join(" ");
    }

    /*

      Loading Data:

      */
    d3.json("6550797.json").then(function(data) {
      /* data.connection.forEach(function(v) {
        if (
          v.start_id != null ||
          v.start_id != "" ||
          v.end_id != null ||
          v.end_id != ""
        ) {
          if (listOfAssignmentNumber1.indexOf(v.assignment_no1) < 0) {
            listOfAssignmentNumber1.push(v.assignment_no1);
          }
          if (listOfID.indexOf(v.id) < 0) {
            listOfID.push(v.id);
          }
        }
      });
      var assignmentIndex = listOfAssignmentNumber1.length - 1;
      var idIndex = listOfID.length - 1; */

      function sliderFunction() {
        /*

      Based on global variables sval1 and sval2

      */
        w.attr("width", global_width + sval1 + sval2);
        ot.selectAll(".hline")
          .attr("x1", function(n) {
            sval2;
            return n.left + (n.d.id > 1 ? sval1 : 0);
          })
          .attr("x2", function(n) {
            return n.left + (n.d.id > 1 ? sval1 : 0);
          });
        r.selectAll("rect.box").attr("x", function(n) {
          if (n.mainCol == 3 && n.recorded_date == "") {
            return n.x - 110 + sval1 + sval2;
          } else {
            if (n.mainCol == 3 && n.recorded_date != "") {
              return n.x - 95 + sval1 + sval2;
            } else {
              if (n.mainCol == 2) {
                return n.x - 95 + sval1;
              } else {
                return n.x - 95;
              }
            }
          }
        });
        o.selectAll(".tline").attr("x2", function(n) {
          return n.mainCol == 3
            ? n.x - 110 + sval1 + sval2
            : n.mainCol == 2
            ? n.x - 95 + sval1
            : n.x - 95;
        });
        r.selectAll(".btext").attr("x", function(n) {
          if (n.type != "Inventor") {
            if (n.mainCol == 3 && n.recorded_date == "") {
              return n.x - 100 + sval1 + sval2;
            } else {
              if (n.mainCol == 3 && n.recorded_date != "") {
                return n.x - 65 + sval1 + sval2;
              } else {
                if (n.mainCol == 2) {
                  return n.x - 65 + sval1;
                } else {
                  return n.x - 65;
                }
              }
            }
          } else {
            return n.x - 84;
          }
        });
        r.selectAll(".btext tspan").attr("x", function(n) {
          if (n.mainCol == 3 && n.recorded_date == "") {
            return n.x - 100 + sval1 + sval2;
          } else {
            if (n.mainCol == 3 && n.recorded_date != "") {
              return n.x - 65 + sval1 + sval2;
            } else {
              if (n.mainCol == 2) {
                return n.x - 65 + sval1;
              } else {
                return n.x - 65;
              }
            }
          }
        });
        r.selectAll(".btext2").attr("x", function(n) {
          if (n.mainCol == 3 && n.recorded_date == "") {
            return n.x - 100 + sval1 + sval2;
          } else {
            if (n.mainCol == 3 && n.recorded_date != "") {
              return n.x - 84 + sval1 + sval2;
            } else {
              if (n.mainCol == 2) {
                return n.x - 84 + sval1;
              } else {
                return n.x - 84;
              }
            }
          }
        });
        r.selectAll(".btext2 > tspan").attr("x", function(n) {
          if (n.mainCol == 3 && n.recorded_date == "") {
            return n.x - 100 + sval1 + sval2;
          } else {
            if (n.mainCol == 3 && n.recorded_date != "") {
              return n.x - 84 + sval1 + sval2;
            } else {
              if (n.mainCol == 2) {
                return n.x - 84 + sval1;
              } else {
                return n.x - 84;
              }
            }
          }
        });
        r.selectAll("a image").attr("x", function(n) {
          if (n.mainCol == 3 && n.recorded_date != "") {
            return n.x - 90 + sval1 + sval2;
          } else {
            if (n.mainCol == 2) {
              return n.x - 90 + sval1;
            } else {
              return n.x - 90;
            }
          }
        });
        o.selectAll(".connection").each(function() {
          var u = d3.select(this.parentNode).datum(),
            f = d3.select(this).datum(),
            n = [],
            t,
            r;
          f.forEach(function(t) {
            n.push([t[0], t[1]]);
          });
          t = hList[u.start_id];
          r = hList[u.end_id];
          t.mainCol == 3
            ? ((n[0][0] += sval1 + sval2), (n[1][0] += sval1 + sval2))
            : t.mainCol == 2 && ((n[0][0] += sval1), (n[1][0] += sval1));
          r.mainCol == 3
            ? ((n[2][0] += sval1 + sval2), (n[3][0] += sval1 + sval2))
            : r.mainCol == 2 && ((n[2][0] += sval1), (n[3][0] += sval1));
          d3.select(this).attr("d", ht(n));
        });
      }

      function disableCheck() {
        /*

      Function for disabling checkboxes when using step functions:

      */

        if (
          e != f.length - 1 ||
          idIndex != listOfID.length - 1 ||
          assignmentIndex != listOfAssignmentNumber1.length - 1
        ) {
          document.getElementById("checkbox-ownership").disabled = true;
          document.getElementById("checkbox-ownership").checked = true;
          document.getElementById("checkbox-security").disabled = true;
          document.getElementById("checkbox-security").checked = true;
          document.getElementById("checkbox-3rdparties").disabled = true;
          document.getElementById("checkbox-3rdparties").checked = true;
          document.getElementById("checkbox-release").disabled = true;
          document.getElementById("checkbox-release").checked = true;
          document.getElementById("checkbox-license").disabled = true;
          document.getElementById("checkbox-license").checked = true;
          document.getElementById("checkbox-license-end").disabled = true;
          document.getElementById("checkbox-license-end").checked = true;
        } else {
          document.getElementById("checkbox-ownership").disabled = false;
          document.getElementById("checkbox-security").disabled = false;
          document.getElementById("checkbox-3rdparties").disabled = false;
          document.getElementById("checkbox-release").disabled = false;
          document.getElementById("checkbox-license").disabled = false;
          document.getElementById("checkbox-license-end").disabled = false;
        }
      }

      function stepAssignment() {
        /*

      Step buttons using 'assignment_no1' paramater

      */
        var boxes = [];
        e = -1;
        idIndex = -1;

        o.selectAll(".connection").each(function() {
          var n = d3.select(this.parentNode).datum(),
            t = 1;
          if (
            listOfAssignmentNumber1.indexOf(+n.assignment_no1) > assignmentIndex
          ) {
            t = 0;
          } else {
            if (f.indexOf(n.date) > e) {
              e = f.indexOf(n.date);
            }
            if (listOfID.indexOf(+n.id) > idIndex) {
              idIndex = listOfID.indexOf(+n.id);
            }
            boxes.push(n.box_creator_id);
            boxes.push(n.box_creator_id2);
          }

          if (
            +n.assignment_no1 === listOfAssignmentNumber1[assignmentIndex] &&
            researchModeActive === 1
          ) {
            var ev = document.createEvent("UIEvents");
            ev.initUIEvent("click", true, true, window, 1);
            d3.select(this)
              .node()
              .dispatchEvent(ev);
              d3.select(this).style("stroke-width", 5) 
          } else {
            d3.select(this).style("stroke-width", 2)
          }

          var testA = d3.select(this).style("opacity");

          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");

          var testB = d3.select(this).style("opacity");

          if (testA != testB) {
            data.box.forEach(function(v) {
              if (n.box_creator_id === v.id || n.box_creator_id2 === v.id) {
              }
            });
          }
        });

        o.selectAll(".comment-circle").each(function() {
          var n = d3.select(this).datum(),
            t = 1;
          if (
            listOfAssignmentNumber1.indexOf(+n.assignment_no1) > assignmentIndex
          ) {
            t = 0;
          }

          d3.select(this).style("opacity", t);
        });

        r.selectAll(".box").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this).style("opacity", t);
          //console.log(k, nt, p);
          //console.log(n, t, n.securityOnly);
        });

        r.selectAll(".btext").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this).style("opacity", t);
        });

        r.selectAll(".btext2").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this).style("opacity", t);
        });

        r.selectAll("a").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");
        });

        listOfThead = [];
        o.selectAll(".tline").each(function() {
          var n = d3.select(this).datum(),
            t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
            listOfThead.push(n.execution_date);
          }
          d3.select(this).style("opacity", t);
        });

        o.selectAll(".thead").each(function() {
          var n = d3.select(this).datum(),
            t = 0;
          listOfThead.indexOf(n) >= 0 && (t = 1);
          d3.select(this).style("opacity", t);
        });

        o.selectAll(".thead2").each(function() {
          var n = d3.select(this).datum(),
            t = 0;
          listOfThead.indexOf(n) >= 0 && (t = 1);
          d3.select(this).style("opacity", t);
        });
        disableCheck();
      }

      function stepID() {
        /*

      Step buttons using 'id' paramter

      */
        var boxes = [];
        e = -1;

        assignmentIndex = -1;
        o.selectAll(".connection").each(function() {
          var n = d3.select(this.parentNode).datum(),
            t = 1;

          if (listOfID.indexOf(+n.id) > idIndex) {
            t = 0;
          } else {
            if (f.indexOf(n.date) > e) {
              e = f.indexOf(n.date);
            }
            if (
              listOfAssignmentNumber1.indexOf(+n.assignment_no1) >
              assignmentIndex
            ) {
              assignmentIndex = listOfAssignmentNumber1.indexOf(
                +n.assignment_no1
              );
            }
            boxes.push(n.box_creator_id);
            boxes.push(n.box_creator_id2);
          }

          if (+n.id === listOfID[idIndex] && researchModeActive === 1) {
            var ev = document.createEvent("UIEvents");
            ev.initUIEvent("click", true, true, window, 1);
            d3.select(this)
              .node()
              .dispatchEvent(ev);
            d3.select(this).classed("active", !0) 
          } else {
            d3.select(this).classed("active", !1)
          }

          var testA = d3.select(this).style("opacity");

          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");
          var testB = d3.select(this).style("opacity");
        });

        o.selectAll(".comment-circle").each(function() {
          var n = d3.select(this).datum(),
            t = 1;
          if (listOfID.indexOf(+n.id) > idIndex) {
            t = 0;
          }

          d3.select(this).style("opacity", t);
        });

        r.selectAll(".box").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this).style("opacity", t);
          //console.log(k, nt, p);
          //console.log(n, t, n.securityOnly);
        });

        r.selectAll(".btext").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this).style("opacity", t);
          //console.log(k, nt, p);
          //console.log(n, t, n.securityOnly);
        });

        r.selectAll(".btext2").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this).style("opacity", t);
          //console.log(k, nt, p);
          //console.log(n, t, n.securityOnly);
        });

        r.selectAll("a").each(function(n) {
          var t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
          }
          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");
        });

        listOfThead = [];
        o.selectAll(".tline").each(function() {
          var n = d3.select(this).datum(),
            t = 0;
          if (boxes.indexOf(n.id) >= 0 || n.type == "Inventor") {
            t = 1;
            listOfThead.push(n.execution_date);
          }
          d3.select(this).style("opacity", t);
        });

        o.selectAll(".thead").each(function() {
          var n = d3.select(this).datum(),
            t = 0;
          listOfThead.indexOf(n) >= 0 && (t = 1);
          d3.select(this).style("opacity", t);
        });

        o.selectAll(".thead2").each(function() {
          var n = d3.select(this).datum(),
            t = 0;
          listOfThead.indexOf(n) >= 0 && (t = 1);
          d3.select(this).style("opacity", t);
        });
        disableCheck();
      }

      function checked() {
        /*

      Checkbox function

      */

        check_list = [];
        if (ch_security === 0) {
          check_list.push("Security");
        }
        if (ch_release === 0) {
          check_list.push("Release");
        }
        if (ch_license_end === 0) {
          check_list.push("License End");
        }
        if (ch_license === 0) {
          check_list.push("License");
        }
        if (ch_ownership === 0) {
          check_list.push("Ownership");
        }
        if (ch_3rd_parties === 0) {
          check_list.push("3rdParties");
        }

        check_list.forEach(function(v) {
          if (v === "License End" || v === "License") {
            var boxToRemove = [];
            var boxToKeep = [];
            o.selectAll(".connection").each(function() {
              var n = d3.select(this.parentNode).datum();
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
                boxToRemove.push(n.box_creator_id);
              } else {
                boxToKeep.push(n.start_id);
              }

              //d3.select(this).style("opacity", t);
            });

            r.selectAll(".btext").each(function(n) {
              //var t = 1;

              if (v === "Security" || v === "License") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  n.hide = true;
                  //t = 0;
                }
              }
              if (v === "Release" || v === "Licence End") {
                if (boxToRemove.indexOf(n.id) >= 0) {
                  //t = 0;
                  n.hide = true;
                }
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".box").each(function(n) {
              //var t = 1;

              if (v === "Security" || v === "License") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                }
              }
              if (v === "Release" || v === "Licence End") {
                if (boxToRemove.indexOf(n.id) >= 0) {
                  //t = 0;
                  n.hide = true;
                }
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".btext2").each(function(n) {
              //var t = 1;

              if (v === "Security" || v === "License") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                }
              }
              if (v === "Release" || v === "Licence End") {
                if (boxToRemove.indexOf(n.id) >= 0) {
                  //t = 0;
                  n.hide = true;
                }
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll("a").each(function(n) {
              //var t = 1;

              if (v === "Security" || v === "License") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                }
              }
              if (v === "Release" || v === "Licence End") {
                if (boxToRemove.indexOf(n.id) >= 0) {
                  //t = 0;
                  n.hide = true;
                }
              }

              //d3.select(this).style("opacity", t);
            });

            o.selectAll(".tline").each(function() {
              var n = d3.select(this).datum();
              //var t = 1;

              if (v === "Security" || v === "License") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                } else {
                }
              }
              if (v === "Release" || v === "License End") {
                if (boxToRemove.indexOf(n.id) >= 0) {
                  //t = 0;
                  n.hide = true;
                } else {
                }
              }

              d3.select(this).style("opacity", t);
            });
          }
          if (v === "Release") {
            var boxToRemove = [];
            var boxToKeep = [];
            o.selectAll(".connection").each(function() {
              var n = d3.select(this.parentNode).datum();
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
                boxToRemove.push(n.box_creator_id);
              } else {
                boxToKeep.push(n.start_id);
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".btext").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 &&
                boxToKeep.indexOf(n.id) < 0
              ) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".box").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 &&
                boxToKeep.indexOf(n.id) < 0
              ) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".btext2").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 &&
                boxToKeep.indexOf(n.id) < 0
              ) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll("a").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 &&
                boxToKeep.indexOf(n.id) < 0
              ) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            o.selectAll(".tline").each(function() {
              var n = d3.select(this).datum();
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 &&
                boxToKeep.indexOf(n.id) < 0
              ) {
                //t = 0;
                n.hide = true;
              }

              d3.select(this).style("opacity", t);
            });
          }
          if (v === "Security") {
            var boxToRemove = [];
            var boxToKeep = [];
            o.selectAll(".connection").each(function() {
              var n = d3.select(this.parentNode).datum();
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
                boxToRemove.push(n.box_creator_id);
              }
              if (n.type === "Release") {
                boxToKeep.push(n.start_id);
              }

              //d3.select(this).style("opacity", t);
            });
            console.log("to remove", boxToRemove);
            console.log("to keep", boxToKeep);
            r.selectAll(".btext").each(function(n) {
              //var t = 1;

              if (v === "Security") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  n.hide = true;
                  //t = 0;
                }
              }
              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".box").each(function(n) {
              //var t = 1;

              if (v === "Security") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                }
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".btext2").each(function(n) {
              //var t = 1;

              if (v === "Security") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                }
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll("a").each(function(n) {
              //var t = 1;

              if (v === "Security") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                }
              }

              //d3.select(this).style("opacity", t);
            });
            o.selectAll(".tline").each(function() {
              var n = d3.select(this).datum();
              //var t = 1;

              if (v === "Security") {
                if (
                  boxToRemove.indexOf(n.id) >= 0 &&
                  boxToKeep.indexOf(n.id) < 0
                ) {
                  //t = 0;
                  n.hide = true;
                } else {
                }
              }

              d3.select(this).style("opacity", t);
            });
          }
          if (v === "Ownership") {
            var boxToRemove = [];
            var boxToRemoveAdditional = [];
            o.selectAll(".connection").each(function() {
              var n = d3.select(this.parentNode).datum();
              if (n.type === v) {
                //t = 0
                boxToRemove.push(n.end_id);
              }
            });
            o.selectAll(".connection").each(function() {
              var n = d3.select(this.parentNode).datum();
              if (n.type === "Name Change") {
                if (boxToRemove.indexOf(n.start_id) >= 0) {
                  boxToRemoveAdditional.push(n.box_creator_id);
                }
              }
            });
            o.selectAll(".connection").each(function() {
              var n = d3.select(this.parentNode).datum();
              //var t = 1;
              if (
                boxToRemove.indexOf(n.start_id) >= 0 ||
                boxToRemove.indexOf(n.end_id) >= 0 ||
                boxToRemoveAdditional.indexOf(n.start_id) >= 0 ||
                boxToRemoveAdditional.indexOf(n.end_id) >= 0
              ) {
                //t = 0;
                n.hide = true;
              }
              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".btext").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 ||
                boxToRemoveAdditional.indexOf(n.id) >= 0
              ) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".box").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 ||
                boxToRemoveAdditional.indexOf(n.id) >= 0
              ) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll(".btext2").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 ||
                boxToRemoveAdditional.indexOf(n.id) >= 0
              ) {
                //t = 0;
                n.hide = true;
              }

              // d3.select(this).style("opacity", t);
            });
            r.selectAll("a").each(function(n) {
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 ||
                boxToRemoveAdditional.indexOf(n.id) >= 0
              ) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            var listOfThead = [];
            var listToKeep = [];
            o.selectAll(".tline").each(function() {
              var n = d3.select(this).datum();
              //var t = 1;

              if (
                boxToRemove.indexOf(n.id) >= 0 ||
                boxToRemoveAdditional.indexOf(n.id) >= 0
              ) {
                //t = 0;
                n.hide = true;
              } else {
              }

              //d3.select(this).style("opacity", t);
            });
          }
          if (v === "3rdParties") {
            var linesToRemove = [];
            r.selectAll(".btext").each(function(n) {
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
                linesToRemove.push(n.id);
              }

              //d3.select(this).style("opacity", t);
            });

            r.selectAll(".box").each(function(n) {
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
                //console.log(n)
              }

              //d3.select(this).style("opacity", t);
            });

            r.selectAll(".btext2").each(function(n) {
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });
            r.selectAll("a").each(function(n) {
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
              }

              //d3.select(this).style("opacity", t);
            });

            o.selectAll(".tline").each(function(n) {
              var n = d3.select(this).datum();
              //var t = 1;

              if (n.type === v) {
                //t = 0;
                n.hide = true;
              } else {
              }

              //d3.select(this).style("opacity", t);
            });

            o.selectAll(".connection").each(function() {
              var n = d3.select(this.parentNode).datum();
              //var t = 1;
              if (
                linesToRemove.indexOf(n.start_id) >= 0 ||
                linesToRemove.indexOf(n.end_id) >= 0
              ) {
                //t = 0;

                n.hide = true;
              }
              d3.select(this).style("opacity", t);
            });
          }
        });

        r.selectAll(".box").each(function(n) {
          var t = 1;
          if (n.hide === true) {
            t = 0;
          }
          //n.hide = false;
          d3.select(this).style("opacity", t);
        });

        r.selectAll(".btext").each(function(n) {
          var t = 1;
          if (n.hide === true) {
            t = 0;
          }
          //n.hide = false;
          d3.select(this).style("opacity", t);
          if (
            n.mainCol === 3 &&
            (n.recorded_date == "" || n.recorded_date == null)
          ) {
            n.hide = false;
          }
        });

        r.selectAll(".btext2").each(function(n) {
          var t = 1;
          if (n.hide === true) {
            t = 0;
          }
          //n.hide = false;
          d3.select(this).style("opacity", t);
        });

        r.selectAll("a").each(function(n) {
          var t = 1;
          if (n.hide === true) {
            t = 0;
          }
          //n.hide = false;
          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");
        });

        o.selectAll(".connection").each(function() {
          var n = d3.select(this.parentNode).datum();
          var t = 1;
          if (n.hide === true) {
            t = 0;
          }
          n.hide = false;
          d3.select(this).style("opacity", t);
        });

        var listOfThead = [];
        var listToKeep = [];
        o.selectAll(".tline").each(function() {
          var n = d3.select(this).datum();
          var t = 1;
          if (n.hide === true) {
            t = 0;
            listOfThead.push(n.execution_date);
          } else {
            listToKeep.push(n.execution_date);
          }
          n.hide = false;

          d3.select(this).style("opacity", t);
        });

        o.selectAll(".thead").each(function() {
          var n = d3.select(this).datum();
          var t = 0;

          if (listToKeep.indexOf(n) >= 0) {
            t = 1;
          }

          d3.select(this).style("opacity", t);
        });
        o.selectAll(".thead2").each(function() {
          var n = d3.select(this).datum();
          var t = 0;

          if (
            listToKeep.indexOf(n) >= 0 &&
            listToKeep.indexOf(c[c.indexOf(n) - 1]) >= 0
          ) {
            t = 1;
          }

          d3.select(this).style("opacity", t);
        });

        /* r.selectAll(".box").each(function(n) {
          var t = 1;



          d3.select(this).style("opacity", t);
        }); */
        /*r.selectAll(".btext2").each(function(n) {
          var t = 1;
          if (n.type === type) {
            t = 0;
          }
          d3.select(this).style("opacity", t);
        });
        r.selectAll(".a").each(function(n) {
          var t = 1;
          if (n.type === type) {
            t = 0;
          }
          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");
        }); */
      }

      function stepControls() {
        /*

      Step buttons for start, finish.

      */

        var k = 0;
        var nt = 0;
        var p = 0;

        r.selectAll(".box").each(function(n) {
          var t = 1;
          k == 0 && (n.mainCol == 2 || n.securityOnly == 1) && (t = 0);
          nt == 0 && n.mainCol == 3 && (t = 0);
          p == 0 && n.dottedOnly == 1 && (t = 0);
          f.indexOf(n.execution_date) > e && (t = 0);
          d3.select(this).style("opacity", t);
          //console.log(k, nt, p);
          //console.log(n, t, n.securityOnly);
        });
        r.selectAll(".btext").each(function(n) {
          var t = 1;
          k == 0 && (n.mainCol == 2 || n.securityOnly == 1) && (t = 0);
          nt == 0 && n.mainCol == 3 && (t = 0);
          p == 0 && n.dottedOnly == 1 && (t = 0);
          f.indexOf(n.execution_date) > e && (t = 0);
          d3.select(this).style("opacity", t);
        });
        r.selectAll(".btext2").each(function(n) {
          var t = 1;
          k == 0 && (n.mainCol == 2 || n.securityOnly == 1) && (t = 0);
          nt == 0 && n.mainCol == 3 && (t = 0);
          p == 0 && n.dottedOnly == 1 && (t = 0);
          f.indexOf(n.execution_date) > e && (t = 0);
          d3.select(this).style("opacity", t);
        });
        r.selectAll("a").each(function(n) {
          var t = 1;
          k == 0 && (n.mainCol == 2 || n.securityOnly == 1) && (t = 0);
          nt == 0 && n.mainCol == 3 && (t = 0);
          p == 0 && n.dottedOnly == 1 && (t = 0);
          f.indexOf(n.execution_date) > e && (t = 0);
          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");
        });
        o.selectAll(".connection").each(function() {
          var n = d3.select(this.parentNode).datum(),
            i = hList[n.start_id],
            r = hList[n.end_id],
            t = 1;
          k == 0 && (i.mainCol == 2 || r.mainCol == 2) && (t = 0);
          nt == 0 && (i.mainCol == 3 || r.mainCol == 3) && (t = 0);
          p == 0 && n.ref_id_go && (t = 0);
          f.indexOf(n.date) > e && (t = 0);
          n.type == "Security" &&
            n.ref_id_go &&
            (n.release_date > f[e]
              ? d3
                  .select(this)
                  .attr("marker-start", null)
                  .style("stroke-dasharray", null)
              : d3.select(this).attr("marker-start", "url(#start1)"));
          //.style("stroke-dasharray", "10,5"));
          d3.select(this)
            .style("opacity", t)
            .style("display", t > 0 ? "inline" : "none");
        });
        o.selectAll(".comment-circle").each(function() {
          var n = d3.select(this).datum(),
            i = hList[n.start_id],
            r = hList[n.end_id],
            t = 1;
          k == 0 && (i.mainCol == 2 || r.mainCol == 2) && (t = 0);
          nt == 0 && (i.mainCol == 3 || r.mainCol == 3) && (t = 0);
          p == 0 && n.ref_id_go && (t = 0);
          f.indexOf(n.date) > e && (t = 0);
          d3.select(this).style("opacity", t);
        });
        o.selectAll(".tline").each(function() {
          var n = d3.select(this).datum(),
            t = 1;
          f.indexOf(n.execution_date) > e && (t = 0);
          d3.select(this).style("opacity", t);
        });
        o.selectAll(".thead2").each(function() {
          var n = d3.select(this).datum(),
            t = 1;
          f.indexOf(n) > e && (t = 0);
          d3.select(this).style("opacity", t);
        });
        o.selectAll(".thead").each(function() {
          var n = d3.select(this).datum(),
            t = 1;
          f.indexOf(n) > e && (t = 0);
          d3.select(this).style("opacity", t);
        });
      }

      colorOptions = d3
        .map(data.connection, function(n) {
          return n.color;
        })
        .keys();

      /*

      DATA WRANGLING & PAGE SETUP:

      */
      var hList = [];
      var c = [];
      var f = [];
      var t = [
        {
          id: 0,
          name: "Ownership",
          leftPad: 40,
          subWidth: 260,
          subHeight: 120,
          sub: 1,
          items: []
        },
        {
          id: 1,
          name: "Security",
          leftPad: 0,
          subWidth: 280,
          subHeight: 120,
          sub: 1,
          items: []
        },
        {
          id: 2,
          name: "License / 3rdParty",
          leftPad: 0,
          subWidth: 300,
          subHeight: 40,
          sub: 1,
          items: [],
          preHeight: 30
        }
      ];
      // end of var t
      data.box.sort(function(n, t) {
        var aDate = new Date(n.execution_date);
        var bDate = new Date(t.execution_date);
        return n.type == "Inventor" && t.type != "Inventor"
          ? -1
          : t.type == "Inventor" && n.type != "Inventor"
          ? 1
          : aDate > bDate
          ? 1
          : aDate < bDate
          ? -1
          : n.id > t.id
          ? 1
          : -1;
      });

      data.connection.forEach(function(t) {
        //t.hide = 0
        var i = data.connection.filter(function(n) {
          return (
            n.start_id == t.start_id &&
            n.end_id == t.end_id &&
            n.type == t.type &&
            n.id < t.id
          );
        });

        /*
        if (i.length > 0) {
          t.hide = !0;
        } */

        /*t.type == "Security" &&
        (i = n.connection
            .filter(function (n) { return n.type == "Release" && n.ref_id == t.id }),
        i.length > 0 && (t.ref_id_go = i[0].id, t.release_date = i[0].date)); */

        if (t.type === "Security") {
          i = data.connection.filter(function(n) {
            return n.type == "Release" && n.ref_id == t.id;
          });
          if (i.length > 0) {
            t.ref_id_go = i[0].id;
            t.release_date = formatDate(i[0].date);
          }
        }

        /*t.type == "Release" &&
          ((i = n.connection.filter(function(n) {
            return n.type == "Security" && n.id == t.ref_id;
          })),
          i.length > 0 && (t.hide = !0)); */
        if (t.type === "Release") {
          i = data.connection.filter(function(n) {
            return n.type === "Security" && n.id == t.ref_id;
          });
          /*if (i.length > 0) {
            t.hide = !0;
          }*/
        }
        t.date = formatDate(t.date);
      });

      // placing boxes in t variable"
      data.box.forEach(function(n) {
        var r, u, e, o, s;
        n.subCol = 1;
        // populating t list:
        if (n.segment === "1" || n.segment === "0") {
          n.mainCol = 1;
          tEntry = t[0];
        }
        if (n.segment === "2") {
          n.mainCol = 2;
          tEntry = t[1];
        }
        if (n.segment === "3") {
          n.mainCol = 3;
          tEntry = t[2];
        }
        // populating 'c' list (list of unique dates)
        if (n.execution_date !== "") {
          //unnecessary and should fix:

          n.entryDateFormatted = formatDate(n.execution_date);

          n.execution_date = formatDate(n.execution_date);

          if (tEntry.items.length !== 0) {
            if (
              n.execution_date ===
              tEntry.items[tEntry.items.length - 1].execution_date
            ) {
              n.subCol = tEntry.items[tEntry.items.length - 1].subCol + 1;
            }
          } else {
            n.subCol = 1;
          }

          if (tEntry.sub < n.subCol) {
            tEntry.sub = n.subCol;
          }
          if (c.indexOf(n.execution_date) < 0) {
            c.push(n.execution_date);
            f.push(n.execution_date);
          }
        }
        hList[n.id] = n;
        u = data.connection.filter(function(d) {
          return d.end_id == n.id; //&& !d.hide;
        });
        e = data.connection.filter(function(d) {
          return d.start_id == n.id; //&& !d.hide;
        });
        n.inTypes = d3
          .map(u, function(n) {
            return n.type;
          })
          .keys();
        n.outTypes = d3
          .map(e, function(n) {
            return n.type;
          })
          .keys();
        n.dottedOnly = 1;
        n.securityOnly = n.mainCol == 3 ? 1 : 0;
        if (
          n.type === "3rdParties" &&
          (n.execution_date === null || n.execution_date === "")
        ) {
          if (u.length > 0) {
            n.execution_date = d3.min(u, function(n) {
              return formatDate(n.date);
            });
          }
          s = d3.min(e, function(n) {
            return formatDate(n.date);
          });
          if (
            n.execution_date === null ||
            n.execution_date === "" ||
            n.execution_date > s
          ) {
            n.execution_date = s;
          }
          // here
        }

        //n.step = c.indexOf(n.entryDateFormatted);
        tEntry.items.push(n);
      });

      data.box.forEach(function(n) {
        if (
          (n.step = -1 && n.execution_date != null && n.execution_date != "")
        ) {
          var t = n.execution_date + (n.type == "Inventor" ? "d" : "");
          n.step = c.indexOf(t);
        }
      });
      data.connection.forEach(function(n) {
        if ((n.step = -1) /*, !n.hide*/) {
          var t = hList[n.start_id],
            i = hList[n.end_id];
          t != null &&
            i != null &&
            (n.step =
              t.step >= 0 && i.step >= 0
                ? Math.max(t.step, i.step)
                : t.step >= 0
                ? t.step
                : i.step);
        }
      });
      data.box.forEach(function(t) {
        if (t.execution_date == null || t.execution_date == "") {
          var i = data.connection.filter(function(n) {
            return (n.end_id == t.id || n.start_id == t.id) && n.step >= 0;
          });
          i.length > 0 &&
            (t.step = d3.min(i, function(n) {
              return n.step;
            }));
        }
      });

      /*

      PAGE DEFINITION:

      */
      var container = d3.select("#container"),
        u = { top: 40, left: 260, right: 20, bottom: 40 },
        et = d3.sum(t, function(n) {
          return n.leftPad + n.sub * n.subWidth * (n.items.length > 0 ? 1 : 0);
        }),
        pt = Math.max(
          c.length * t[0].subHeight,
          t[2].items.length * t[2].subHeight + t[2].preHeight
        ),
        global_height = pt + u.top + u.bottom;
      if (global_height < window.innerHeight) {
        global_height = window.innerHeight + 20;
      }
      global_width = et + u.left + u.right;
      if (global_width < window.innerWidth) {
        global_width = window.innerWidth;
      }
      (w = container
        .append("svg")
        .attr("width", global_width)
        .attr("height", global_height)),
        (wt = w.append("defs")),
        (ot = w.append("g").attr("transform", "translate(" + u.left + ",0)")),
        (o = w
          .append("g")
          .attr("transform", "translate(" + u.left + "," + u.top + ")")),
        (r = w
          .append("g")
          .attr("transform", "translate(" + u.left + "," + u.top + ")"));
      bm = w
        .append("g")
        .attr("transform", "translate(" + u.left + "," + u.top + ")");

      colorOptions.forEach(function(n, t) {
        wt.append("marker")
          .attr("id", "end" + t)
          .attr("viewBox", "0 -5 10 10")
          .attr("refX", 10)
          .attr("refY", 0)
          .attr("markerWidth", 12)
          .attr("markerHeight", 12)
          .attr("markerUnits", "userSpaceOnUse")
          .attr("orient", "auto")
          .append("svg:path")
          .attr("d", "M0,-5L10,0L0,5")
          .style("fill", n);
        wt.append("marker")
          .attr("id", "start" + t)
          .attr("viewBox", "0 -5 10 10")
          .attr("refX", 0)
          .attr("refY", 0)
          .attr("markerWidth", 12)
          .attr("markerHeight", 12)
          .attr("markerUnits", "userSpaceOnUse")
          .attr("orient", "auto")
          .append("svg:path")
          .attr("d", "M10,-5L0,0L10,5")
          .style("fill", n);
      });

      /*

      BOXES DEFINITION:

      */
      b = 0;
      st = 0;
      t.forEach(function(n, index) {
        if (n.id === 0) {
          tlineDist = 95;
        }
        if (n.id === 1) {
          tlineDist = 95;
        }
        if (n.id === 2) {
          tlineDist = 110;
        }

        if (index === 0) {
          ot.append("line")
            .attr("class", "hline")
            .datum({ left: b, d: n })
            .attr("x1", b)
            .attr("y1", 20)
            .attr("x2", b)
            .attr("y2", global_height - 20);
        }

        missing = 0;
        n.items.forEach(function(m, index) {
          m.x = b + n.leftPad + (m.subCol - 1) * n.subWidth + n.subWidth / 2;
          if (
            m.mainCol == 3 &&
            (m.execution_date == null ||
              m.execution_date == "" ||
              m.recorded_date == null ||
              m.recorded_date == "")
          ) {
            m.y =
              (index - missing) * n.subHeight +
              n.subHeight / 2 +
              n.preHeight +
              st;

            var boxThreeWidth = 230;

            l = r
              .append("rect")
              .attr("class", "box")
              .datum(m)
              .attr("x", m.x - 110)
              .attr("rx", function() {
                if (m.type !== "Inventor") {
                  return 5;
                } else {
                  return 0;
                }
              })
              .attr("ry", function() {
                if (m.type !== "Inventor") {
                  return 5;
                } else {
                  return 0;
                }
              })
              .attr("id", function(d) {
                return "box-" + d.id;
              })
              .attr("width", boxThreeWidth)
              .attr("fill", m.background_color)
              .style("stroke", m.border_color)
              .style("stroke-width", m.border_linepx)
              .on("click", function(d) {
                var boxX = d3.select(this).attr("x");
                var boxY = d3.select(this).attr("y");
                boxmenuNEW(d, boxX, boxY);
              });

            if (m.name.length <= 35) {
              l.attr("y", m.y - 15).attr("height", 30);

              r.append("text")
                .attr("class", "btext box-3")
                .datum(m)
                .attr("x", m.x - 100)
                .attr("y", m.y)
                .attr("dy", "0.32em")
                .text(m.name);
            } else {
              st += 10;
              m.y += 5;
              l.attr("y", m.y - 20).attr("height", 40);
              a = m.name.substr(0, 35).lastIndexOf(" ");
              y = m.name.substr(a + 1);

              r.append("text")
                .attr("class", "btext box-3")
                .datum(m)
                .attr("x", m.x - 100)
                .attr("y", m.y - 3)
                .text(m.name.substr(0, a))
                .append("tspan")
                .attr("x", m.x - 100)
                .attr("dy", "1.2em")
                .text(y);
            }
          } else {
            if (m.mainCol == 3) {
              missing += 1;
            }
            s = m.document != null && m.document != "";

            var f = Math.round(
              (new Date(m.recorded_date) - new Date(m.execution_date)) /
                (ft * 365)
            );

            m.y =
              c.lastIndexOf(m.execution_date) * t[0].subHeight +
              t[0].subHeight / 2;

            o.append("line")
              .attr("class", "tline")
              .datum(m)
              .attr("x1", 0)
              .attr("y1", m.y)
              .attr("x2", m.x - tlineDist)
              .attr("y2", m.y);

            // ask about this.
            //var boxWidth = +m.dimension.split("x")[0];
            //var boxHeight = +m.dimension.split("x")[1];
            var boxWidth = 190;
            var boxHeight = 72;

            r.append("rect")
              .attr("class", "box")
              .datum(m)
              .attr("x", m.x - boxWidth / 2)
              .attr("y", m.y - boxHeight / 2)
              .attr("rx", function() {
                if (m.type !== "Inventor") {
                  return 5;
                } else {
                  return 0;
                }
              })
              .attr("ry", function() {
                if (m.type !== "Inventor") {
                  return 5;
                } else {
                  return 0;
                }
              })
              .attr("id", function(d) {
                return "box-" + d.id;
              })
              .attr("width", boxWidth)
              .attr("height", boxHeight)
              .attr("fill", m.background_color)
              .style("stroke", m.border_color)
              .style("stroke-width", m.border_linepx)
              .on("click", function(d) {
                var boxX = d3.select(this).attr("x");
                var boxY = d3.select(this).attr("y");
                boxmenuNEW(d, boxX, boxY);
              });
            if (m.name.length <= 22 || m.type === "Inventor") {
              r.append("text")
                .attr("class", "btext")
                .datum(m)
                .attr("x", m.x - (s ? 65 : 84))
                .attr("y", m.y - 8)
                .text(m.name);
            } else {
              h = m.name.substr(0, 22).lastIndexOf(" ");
              e = m.name.substr(h + 1);
              if (e.length > 22) {
                e = e.substr(0, 22) + "...";
              }

              r.append("text")
                .attr("class", "btext")
                .datum(m)
                .attr("x", m.x - 65)
                .attr("y", m.y - 18)
                .text(m.name.substr(0, h))
                .append("tspan")
                .attr("x", m.x - 65)
                .attr("dy", "1.2em")
                .text(e);
            }

            r.append("text")
              .attr("class", "btext2")
              .datum(m)
              .attr("x", m.x - 84)
              .attr("y", m.y + 15)
              .text("Execution: " + v(m.execution_date))
              .append("tspan")
              .attr("x", m.x - 84)
              .attr("dy", "1.2em")
              .text("Recorded: " + v(m.recorded_date))
              .append("tspan")
              .attr("class", f > 90 ? "active" : "")
              .text(" (" + f + ")");

            if (s) {
              r.append("a")
                .datum(m)
                .attr("xlink:href", m.document)
                .attr("target", "_blank")
                .append("image")
                .attr("x", m.x - 90)
                .attr("y", m.y - 25)
                .attr("width", 20)
                .attr("height", 20)
                .attr("xlink:href", "pdf.svg");
            }
          }
        });

        b += n.leftPad + n.sub * n.subWidth;
      });

      /*

      TIMELINE DEFINITION:

      */
      c.forEach(function(n, i) {
        o.append("text")
          .attr("class", "thead")
          .datum(n)
          .attr("x", -10)
          .attr("y", (i + 0.5) * t[0].subHeight)
          .attr("dy", "0.32em")
          .text(n.replace("d", ""));

        if (i !== 0) {
          o.append("text")
            .attr("class", "thead2")
            .datum(n)
            .attr("x", 5)
            .attr("y", i * t[0].subHeight)
            .attr("dy", "0.32em")
            .text((new Date(n) - new Date(c[i - 1])) / ft + " days");
        }
      });
      ht = d3
        .line()
        .x(function(n) {
          return n[0];
        })
        .y(function(n) {
          return n[1];
        })
        .curve(d3.curveBasis);

      /*

      LINES DEFINITION:

      */

      it = 0;
      var listOfAssignmentNumber1 = [];
      var listOfID = [];
      data.connection.forEach(function(n) {
        var t, i, a, c;
        t = hList[n.start_id];
        i = hList[n.end_id];
        if (t != null && i != null /*&& !n.hide*/) {
          var r,
            u,
            e = [];
          s = n.ref_id_go ? 0 : 1 + t.outTypes.indexOf(n.type);
          c = n.ref_id_go ? 0 : 1 + i.inTypes.indexOf(n.type);
          l = !1;
          t.type == "Ownership" &&
            t.subCol == 1 &&
            i.type == "Ownership" &&
            i.subCol == 1 &&
            i.ownershipIdx - t.ownershipIdx >= 2 &&
            ((l = !0), it++);
          t.type == "3rdParties"
            ? ((r = [t.x - 110, t.y - s * 5]), e.push([r[0] - 50, r[1]]))
            : t.x + 100 < i.x && t.type != "Inventor"
            ? ((r = [t.x + 95, t.y - s * 10]), e.push([r[0] + 50, r[1]]))
            : t.x > i.x + 100 && t.type != "Inventor"
            ? ((r = [t.x - 95, t.y - s * 10]), e.push([r[0] - 50, r[1]]))
            : ((r = [t.x - (l ? it * 10 : 0), t.y + 36]),
              e.push([r[0], r[1] + 20]));
          e.splice(0, 0, r);
          i.type == "3rdParties"
            ? ((u = [i.x - 110, i.y + c * 5]), e.push([u[0] - 50, u[1]]))
            : t.x + 100 < i.x
            ? ((u = [i.x - 95, i.y + c * 10]), e.push([u[0] - 50, u[1]]))
            : t.x > i.x + 100
            ? ((u = [i.x + 95, i.y + c * 10]), e.push([u[0] + 50, u[1]]))
            : ((u = [i.x - (l ? it * 10 : 0), i.y - 36]),
              e.push([u[0], u[1] - 20]));

          e.push(u);

          n.test = e;

          if (f.indexOf(n.date) < 0) {
            f.push(n.date);
          }
          if (n.release_date != null && f.indexOf(n.release_date) < 0) {
            f.push(n.release_date);
          }
          if (listOfAssignmentNumber1.indexOf(+n.assignment_no1) < 0) {
            listOfAssignmentNumber1.push(+n.assignment_no1);
          }
          if (listOfID.indexOf(+n.id) < 0) {
            listOfID.push(+n.id);
          }
          //blink();
        }
      });

      data.connection.forEach(function(n) {
        if (n.type === "Release") {
          data.connection.forEach(function(v) {
            if (v.id === n.ref_id) {
              if (v.start_id === n.start_id) {
                console.log("release connection reference error");
              } else {
                n.test[0] = v.test[3];
                n.test[1] = v.test[2];
                n.test[2] = v.test[1];
                n.test[3] = v.test[0];
              }
            }
          });
        }

        a = o
          .append("g")
          .datum(n)
          .append("path")
          .attr("class", "connection")
          //.attr("id", n.id)
          .datum(n.test)
          .attr("d", ht)
          .style("opacity", 1)
          .attr("marker-end", "url(#end" + colorOptions.indexOf(n.color) + ")")
          .style("stroke", n.color);

        /*if (n.type === "Security") {
            a.attr("marker-start", "url(#start1)");
          } else {
            (t.dottedOnly = 0), (i.dottedOnly = 0);
          }*/

        if (n.type_line === "Dashed") {
          a.style("stroke-dasharray", "10,5");
        }

        if (t.mainCol == 1 && i.mainCol == 3) {
          i.securityOnly = 0;
        }
        if (t.mainCol == 3 && i.mainCol == 1) {
          t.securityOnly = 0;
        }

        //if (n.comment.length > 0) {
        o.append("circle")
          .attr("class", "comment-circle")
          .datum(n)
          .attr("cx", function() {
            if (n.test[0][0] == n.test[2][0]) {
              return n.test[0][0];
            } else {
              if (n.test[0][0] > n.test[2][0]) {
                return n.test[0][0] - 7;
              } else {
                return n.test[0][0] + 7;
              }
            }
          })
          .attr("cy", function() {
            if (n.test[0][0] == n.test[2][0]) {
              if (n.test[0][1] > n.test[2][1]) {
                return n.test[0][1] - 7;
              } else {
                return n.test[0][1] + 7;
              }
            } else {
              return n.test[0][1];
            }
          })
          .attr("r", function() {
            n.comment.forEach(function(v) {
              if (v[0] != null && v[0] != "" && v[1] != null && v[1] != "") {
                return 5;
              } else {
                return 0;
              }
            });
          })
          .style("stroke-width", "3px")
          .style("fill", "white")
          .style("stroke", n.color);
      });

      listOfAssignmentNumber1.sort(function(a, b) {
        return a - b;
      });
      listOfID.sort(function(a, b) {
        return a - b;
      });
      var assignmentIndex = listOfAssignmentNumber1.length - 1;
      var idIndex = listOfID.length - 1;

      f.sort(function(n, t) {
        return n.endsWith("d") && !t.endsWith("d")
          ? -1
          : !n.endsWith("d") && t.endsWith("d")
          ? 1
          : n > t
          ? 1
          : -1;
      });
      // close box menu on outside click:
      var boxMenuElementWithContent = d3.selectAll(
        "#box-menu-svg, #box-menu-svg *"
      );
      var boxElementWithContent = d3.selectAll(".box, .box *");

      console.log(boxMenuElementWithContent);

      function equalToEventTarget() {
        return this == d3.event.target;
      }

      function closeBoxMenu() {
        d3.selectAll("#box-menu-svg").remove();
      }

      d3.select("body").on("click", function() {
        var outsideBoxMenu = boxMenuElementWithContent
          .filter(equalToEventTarget)
          .empty();
        var outsideBox = boxElementWithContent
          .filter(equalToEventTarget)
          .empty();
        if (outsideBoxMenu && outsideBox) {
          d3.selectAll("#box-menu-svg").remove();
        }
      });

      /*

      TOOLBAR DEFINITION:

      */

      l = container
        .append("div")
        .attr("class", "menu")
        .style("width", "200px")
        .style("height", global_height + "px");

      topBar = container
        .append("div")
        .attr("class", "top-bar")
        .style("width", global_width + "px")
        .style("height", "40px")
        .style("background-color", "#FAFAFA")
        .style("position", "fixed")
        .style("z-index", 200);

      topBar
        .append("div")
        .style("top", 10)
        .style("left", 10)
        .attr("width", global_width)
        .attr("id", "top-bar-line")
        .style("border-top", "1px solid #CCCCCC")
        .style("z-index", 300);

      topBar
        .append("div")
        .style("top", "0px")
        .style("left", 10)
        .attr("class", "top-bar-bar-2")
        .style("width", global_width + "px")
        .style("height", "10px")
        .style("background-color", "white")
        .style("position", "fixed")
        .style("z-index", 200);

      topBar
        .append("div")
        .style("top", "10px")
        .style("left", "10px")
        .style("height", "40px")
        .attr("id", "top-bar-line-2")
        .style("border-left", "1px solid #CCCCCC")
        .style("position", "fixed")
        .style("z-index", 400);

      topBar
        .append("div")
        .style("top", "0px")
        .style("left", "0px")
        .style("height", "50px")
        .style("width", "10px")
        .attr("id", "top-bar-line-3")
        .style("position", "fixed")
        .style("background-color", "white")
        .style("z-index", 300);

      menu_contents = l
        .append("div")
        .attr("class", "menu-contents")
        .attr("id", "menu-contents")
        .style("width", "180px")
        .style("height", global_height - 40 + "px")
        .style("top", "50px")
        .style("left", "9px");

      l.append("div")
        .style("top", "40px")
        .style("left", "10px")
        .style("height", global_height - 40 + "px")
        .attr("id", "menu-bar-line")
        .style("position", "fixed")
        .style("border-left", "1px solid #CCCCCC")
        .style("z-index", 300);

      l.append("div")
        .style("top", "0px")
        .style("left", "0px")
        .style("height", global_height - 40 + "px")
        .style("width", "10px")
        .attr("id", "menu-bar-bar")
        .style("background-color", "white")
        .style("position", "fixed")
        .style("z-index", 100);

      var menu_logo = menu_contents
        .append("div")
        .attr("class", "menu-logo")
        .style("top", "0px")
        .style("left", "23px")
        .style("width", "134px")
        .style("height", "48px")
        .style("position", "absolute")
        .style("z-index", 100)
        .style("border-style", "solid")
        .style("border-width", "1px")
        .style("border-radius", "10px");

      menu_logo
        .append("img")
        .attr("width", 78)
        .attr("height", "auto")
        .style("padding-bottom", "2px")
        .style("padding-top", "14px")
        .style("padding-left", "7px")
        .attr("src", filePath1);

      menu_logo
        .append("img")
        .attr("width", 32)
        .attr("height", 32)
        .style("padding", "4px")
        .style("margin-top", "4px")
        .style("margin-left", "5px")
        .attr("src", filePath2);

      /* imgSVG
        .append("image")
        .attr("xlink:href", data.general.logo_2)
        .attr("x", -10)
        .attr("y", 70)
        .attr("width", "30px")
        .attr("height", "30px"); */

      legend_container = menu_contents
        .append("div")
        .attr("class", "menu-legend")
        .style("top", "495px")
        .style("left", "10px")
        .style("position", "absolute");

      menu_contents
        .append("text")
        .text(data.general.copyright)
        .style("top", "734px")
        .style("left", "10px")
        .style("opacity", 0.6)
        .style("position", "absolute")
        .style("font-size", "10px");

      topBar
        .append("text")
        .text(data.general.patent_number)
        .style("top", "8px")
        .style("left", "266px")
        .style("position", "absolute")
        .style("font-size", "22px");

      menu_contents
        .append("label")
        .text("Ownership")
        .style("position", "absolute")
        .style("top", "175px")
        .style("left", "51px")
        .style("font-size", "12px");

      ch_ownership = 1;

      menu_contents
        .append("input")
        .attr("type", "checkbox")
        .attr("checked", "checked")
        .style("position", "absolute")
        .attr("id", "checkbox-ownership")
        .style("top", "174px")
        .style("left", "28px")
        .style("width", "15px")
        .style("height", "15px")
        .style("vertical-align", "middle")
        .style("margin-top", "-0.5px")
        .style("margin-right", "5px")
        .on("change", function() {
          ch_ownership = d3.select(this).property("checked") ? 1 : 0;
          //ot.selectAll(".hline").style("opacity", ct);
          //stepControls();
          checked("Ownership");
        });
      var ch_security = 1,
        ch_3rd_parties = 1,
        bt = menu_contents
          .append("label")
          .style("position", "absolute")
          .style("width", "120px")
          .style("top", "198px")
          .style("left", "28px")
          .text("Security")
          .style("font-size", "12px");
      bt.append("input")
        .lower()
        .attr("type", "checkbox")
        .attr("checked", "checked")
        .attr("id", "checkbox-security")
        .style("width", "15px")
        .style("height", "15px")
        .style("vertical-align", "middle")
        .style("margin-top", "-1px")
        .style("margin-right", "5px")
        .on("change", function() {
          ch_security = d3.select(this).property("checked") ? 1 : 0;
          checked("Security");
        });
      rt = menu_contents
        .append("label")
        .style("position", "absolute")
        .style("width", "120px")
        .style("top", "320px")
        .style("left", "28px")
        .text("3rdParty")
        .style("font-size", "12px");
      rt.append("input")
        .lower()
        .attr("type", "checkbox")
        .attr("checked", "checked")
        .attr("id", "checkbox-3rdparties")
        .style("width", "15px")
        .style("height", "15px")
        .style("vertical-align", "middle")
        .style("margin-top", "-1px")
        .style("margin-right", "5px")
        .on("change", function() {
          //nt = d3.select(this).property("checked") ? 1 : 0;
          //stepControls();
          ch_3rd_parties = d3.select(this).property("checked") ? 1 : 0;
          checked("3rdParties");
        });
      ch_release = 1;
      lt = menu_contents
        .append("label")
        .style("position", "absolute")
        .style("width", "120px")
        .style("top", "221px")
        .style("left", "28px")
        .text("Release")
        .style("font-size", "12px");
      lt.append("input")
        .lower()
        .attr("type", "checkbox")
        .attr("checked", "checked")
        .attr("id", "checkbox-release")
        .style("width", "15px")
        .style("height", "15px")
        .style("vertical-align", "middle")
        .style("margin-top", "-1px")
        .style("margin-right", "5px")
        .on("change", function() {
          ch_release = d3.select(this).property("checked") ? 1 : 0;
          checked("Release");
        });
      ch_license = 1;
      rp = menu_contents
        .append("label")
        .style("position", "absolute")
        .style("width", "120px")
        .style("top", "274px")
        .style("left", "28px")
        .text("License")
        .style("font-size", "12px");
      rp.append("input")
        .lower()
        .attr("type", "checkbox")
        .attr("checked", "checked")
        .attr("id", "checkbox-license")
        .style("width", "15px")
        .style("height", "15px")
        .style("vertical-align", "middle")
        .style("margin-top", "-1px")
        .style("margin-right", "5px")
        .on("change", function() {
          ch_license = d3.select(this).property("checked") ? 1 : 0;
          checked("License");
        });
      ch_license_end = 1;
      le = menu_contents
        .append("label")
        .style("position", "absolute")
        .style("width", "120px")
        .style("top", "297px")
        .style("left", "28px")
        .text("License End")
        .style("font-size", "12px");
      le.append("input")
        .lower()
        .attr("type", "checkbox")
        .attr("checked", "checked")
        .attr("id", "checkbox-license-end")
        .style("width", "15px")
        .style("height", "15px")
        .style("vertical-align", "middle")
        .style("margin-top", "-1px")
        .style("margin-right", "5px")
        .on("change", function() {
          ch_license_end = d3.select(this).property("checked") ? 1 : 0;
          checked("License End");
        });

      menu_contents
        .append("text")
        .text("Zoom:")
        .style("top", "523px")
        .style("left", "30px")
        .style("position", "absolute")
        .style("font-size", "12px");

      // comment button:
      menu_comment_button = menu_contents
        .append("a")
        .attr("href", "javascript:void(0)")
        .style("position", "absolute")
        .style("top", "576px")
        .style("left", "32px")
        .append("img")
        .attr("src", "comment.png")
        .attr("id", "menu-comment-button")
        .style("width", "20px")
        .style("height", "20px")
        .on("click", function() {
          a.style("display", "inline");
          a_bg.style("display", "inline");
        });

      menu_contents
        .append("text")
        .text("Your Comments")
        .style("top", "579px")
        .style("left", "58px")
        .style("position", "absolute")
        .style("font-size", "12px");

      e = f.length - 1;

      tt = menu_contents.append("div").attr("class", "buttons");
      /*tt.append("button")
        .text("<")
        .on("click", function() {
          e > 0 && (e--, stepControls());
        });*/
      ttA = tt.append("div").attr("class", "button-rows row-a");
      ttB = tt.append("div").attr("class", "button-rows row-b");
      ttC = tt.append("div").attr("class", "button-rows row-c");

      ttA
        .append("button")
        .text("|<")
        .attr("class", "ui-button ui-widget ui-corner-all custom-button")
        .on("click", function() {
          //e > 0 && ((e = 0), stepControls());
          idIndex = -1;
          assignmentIndex = -1;
          stepID();
        });
      ttA
        .append("button")
        .text(">|")
        .attr("class", "ui-button ui-widget ui-corner-all custom-button")
        .on("click", function() {
          idIndex = listOfID.length - 1;
          assignmentIndex = listOfAssignmentNumber1.length - 1;
          stepID();
          //e < f.length - 1 && ((e = f.length - 1), stepControls());
        });
      ttB
        .append("button")
        .text("<<")
        .attr("class", "ui-button ui-widget ui-corner-all custom-button")
        .on("click", function() {
          if (assignmentIndex >= 0) {
            assignmentIndex--;
            stepAssignment();
          }
        });
      /*tt.append("button")
        .text(">")
        .on("click", function() {
          e < f.length - 1 && (e++, stepControls());
        });*/
      ttB
        .append("button")
        .text(">>")
        .attr("class", "ui-button ui-widget ui-corner-all custom-button")
        .on("click", function() {
          if (assignmentIndex < listOfAssignmentNumber1.length) {
            assignmentIndex++;
            stepAssignment();
          }
        });

      ttC
        .append("button")
        .text("<")
        .attr("class", "ui-button ui-widget ui-corner-all custom-button")
        .on("click", function() {
          if (idIndex >= 0) {
            idIndex--;
            stepID();
          }
        });

      ttC
        .append("button")
        .text(">")
        .attr("class", "ui-button ui-widget ui-corner-all custom-button")
        .on("click", function() {
          if (idIndex < listOfID.length - 1) {
            idIndex++;
            stepID();
          }
        });

      tt2 = l.append("div").attr("class", "buttons2");

      var slider = menu_contents
        .append("div")
        .attr("id", "slider3")
        .style("position", "absolute")
        .style("top", "548px")
        .style("left", "40px")
        .style("width", "108px");

      var ti = menu_contents
          .append("div")
          .attr("id", "slider1")
          .style("position", "absolute")
          .style("top", "251px")
          .style("left", "40px")
          .style("width", "108px"),
        kt = menu_contents
          .append("div")
          .attr("id", "slider2")
          .style("position", "absolute")
          .style("top", "350px")
          .style("left", "40px")
          .style("width", "108px"),
        sval1 = 0,
        sval2 = 0;
      $("#slider1").slider({
        range: "min",
        value: 0,
        min: 0,
        max: 400,
        slide: function(n, t) {
          sval1 = t.value;
          sliderFunction();
        },  
      });
      $("#slider2").slider({
        range: "min",
        value: 0,
        min: 0,
        max: 400,
        slide: function(n, t) {
          sval2 = t.value;
          sliderFunction();
        }
      });
      sval3 = 1;
      $("#slider3").slider({
        range: "min",
        value: 100,
        min: 50,
        max: 200,
        slide: function(n, t) {
          sval3 = t.value / 100;
          zoomFunction();
        },  
      });

      /*

      LEGEND DEFINITION:

      */
      var legendHeight = data.legend.length * 18 + 12;
      var legendSVG = menu_contents
        .append("svg")
        .style("top", "446px")
        .style("left", "40px")
        .style("position", "fixed")
        .attr("class", "legend-svg")
        .attr("height", legendHeight)
        .attr("width", 108)
        .append("g")
        .attr("transform", "translate(" + legendHeight / 2 + "," + 200 + ")");

      menu_contents
        .append("text")
        .text("Line Color:")
        .style("top", "382px")
        .style("left", "30px")
        .style("position", "absolute")
        .style("font-size", "12px");

      data.legend.forEach(function(v, i) {
        var legendSVG = menu_contents
          .append("text")
          .attr("id", "legend-id-" + v.id)
          .text(v.tooltip)
          .style("top", i * 18 + 400 + "px")
          .style("left", "36px")
          .style("position", "absolute")
          .style("font-size", "12px")
          .style("color", v.color);
      });

      console.log(data.box);
      console.log(data.connection);

      l.append("span")
        .attr("id", "menu-toggle")
        .style("font-size", "14px")
        .attr("class", "ui-icon ui-icon-close")
        .style("cursor", "pointer")
        .style("position", "fixed")
        .style("top", "48px")
        .style("left", "169px")
        .style("z-index", "1000");

      /*var textVar = "";
      textVar += "<div>";
      textVar += "<table class='legend-table'>";
      textVar += "<tr>";
      data.legend.forEach(function(v) {
        textVar +=
          "<td class='legend-header' id='legend-id-" +
          v.id +
          "'>" +
          v.tooltip +
          "<\/td>";
        textVar += "<td>" + v.explanation + "<\/td><\/tr>";
      });
      textVar += "<\/table>";
      textVar += "<\/div>";

      if (textVar.length > 0) {
        legend_container.html(textVar).style("display", "inline");
      } else {
        legend_container.html("").style("display", "none");
      }
      data.legend.forEach(function(v) {
        d3.select("#legend-id-" + v.id).style("color", v.color);
      });*/

      var gt = container
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0),
        d = container
          .append("div")
          .attr("class", "popup")
          .style("display", "none"),
        legend_container = container
          .append("div")
          .attr("class", "legend-tooltip")
          .style("display", "none"),
        a_bg = container
          .append("div")
          .attr("class", "popup-comment-bg")
          .style("display", "none"),
        a = container
          .append("div")
          .attr("class", "popup-comment")
          .style("display", "none");
      a.html(
        "<div><textarea id='popup-comment-textarea'><\/textarea><a class='close' href='javascript:void(0)'>Close<\/a><a class='save' href='javascript:void(0)'>Save<\/a><\/div>"
      );
      d3.select("#popup-comment-textarea").style("width", "360px");

      o.selectAll(".connection")
        .on("mouseover", function() {
          if (d3.select(this).style("opacity") != 0) {
            var n = d3.select(this.parentNode).datum();
            //var t = data.assignments[+n.assignment_no1].original;
            i = d3.mouse(w.node());
            gt.html(n.tooltip)
              .style("left", i[0] + 10 + "px")
              .style("top", i[1] - 10 + "px")
              .style("opacity", 1);
          }
        })
        .on("mouseout", function() {
          gt.style("opacity", 0);
        })
        .on("click", function() {
          researchModeActive = 1;
          var c;
          var i = d3.select(this.parentNode).datum(),
            h = data.popup.filter(function(n) {
              return n.id == i.popuptop;
            }),
            c = data.popup.filter(function(n) {
              return n.id == i.popupbottom;
            }),
            t = "",
            r = [],
            u,
            s,
            l;
          researchModeAssignmentNo1 = i.assignment_no1;
          researchModeId = i.id;
          if (o.selectAll(".connection.active").classed("active", !1) && researchModeActive === 0) {
            console.log('test')
            d3.select(this).classed("active", !0);
          }
          if (h.length > 0) {
            r.push(h[0]);
          }
          if (c.length > 0) {
            r.push(c[0]);
          }
          if (i.ref_id_go && i.release_date <= f[e]) {
            u = data.connection.filter(function(n) {
              return n.id == i.ref_id_go;
            });
            if (u.length > 0) {
              s = data.popup.filter(function(n) {
                return n.id == u[0].popuptop;
              });
              l = data.popup.filter(function(n) {
                return n.id == u[0].popupbottom;
              });
              if (s.length > 0) {
                r.splice(0, 0, s[0]);
              }
            }
          }
          /*

            POPUP DEFINITION:

            */
          r.forEach(function(n, u) {
            t +=
              "<div class='popup-div' data-id='" +
              u +
              "'><a class='close' href='javascript:void(0)'>Close<\/a>";
            t +=
              "<a data-id='" +
              i.id +
              "' data-idx='" +
              u +
              "' class='comment' href='javascript:void(0)'>";
            t +=
              "<img src='comment.png' id='comment-img-" +
              u +
              "' style='width: 20px; height: 20px;' /><\/a>";
            t += "<label>" + n.conveyanceText + "<\/label>";
            t += "<table class='top'>";
            t += "<tr><td>Execution Date<br/>" + v(n.patAssignorEarliestExDate);
            var f = r.length == 1 || u > 0 ? i.document1 : i.document2;
            t +=
              "<a href='" +
              f +
              "' target='_blank' style='position: absolute; top: 42px; left: 100px;'><img src='pdf.svg' id='doc-img-" +
              u +
              "' style='width: 20px; height: 20px;' /><\/a><\/td><td>Reel/frame<br/>" +
              n.displayId +
              "<\/td><\/tr>";
            t +=
              "<tr><td>Assignors<br/>" +
              n.patAssignorName.join("<br/>") +
              "<\/td><td style='position: relative'>Date Recorded<br/>" +
              v(n.recordedDate) +
              "<\/td><\/tr>";
            t += "<tr><td>Assignee<br/>" + n.patAssigneeName.join("<br/>");
            n.patAssigneeAddress1.length == 1 &&
              n.patAssigneeAddress1[0] != "NULL" &&
              (t += "<br/>" + n.patAssigneeAddress1[0]);
            n.patAssigneeCity.length == 1 &&
              n.patAssigneePostcode.length == 1 &&
              (t +=
                "<br/>" +
                n.patAssigneeCity[0] +
                " " +
                n.patAssigneePostcode[0]);
            t +=
              "<\/td><td>Correspondent<br/>" +
              n.corrName +
              "<br/>" +
              n.corrAddress1 +
              "<br/>" +
              n.corrAddress2 +
              "<br/>" +
              n.corrAddress3 +
              "<\/td><\/tr>";
            t += "<\/table>";
            t +=
              "<label class='prop'><span>+<\/span> Properties (" +
              n.inventionTitle.length +
              " total)<\/label>";
            t += "<table class='bottom' style='display:none'>";
            t +=
              "<thead><tr><th>Patent<\/th><th>Publication<\/th><th>Application<\/th><th>PCT International registration<\/th><\/tr><\/thead>";
            t += "<tbody>";
            n.inventionTitle.forEach(function(i, r) {
              n.patNum[r] == "NULL" && (n.patNum[r] = "");
              n.publNum[r] == "NULL" && (n.publNum[r] = "");
              n.applNum[r] == "NULL" && (n.applNum[r] = "");
              n.pctNum[r] == "NULL" && (n.pctNum[r] = "");
              t +=
                "<tr class='title'><td colspan='4'>" +
                (r + 1) +
                ". " +
                i +
                "<\/td><\/tr>";
              t +=
                "<tr><td>" +
                n.patNum[r] +
                "<\/td><td>" +
                n.publNum[r] +
                "<\/td><td>" +
                n.applNum[r] +
                "<\/td><td>" +
                n.pctNum[r] +
                "<\/td><\/tr>";
            });
            t += "<\/tbody>";
            t += "<\/table>";
            t += "<\/div>";
          });

          // end of r.forEach
          if (t.length > 0) {
            d.html(t).style("display", "inline");
            if (researchModeActive === 1) {
              d3.selectAll(".popup-div").style(
                "width",
                researchModeWidth + "px"
              );
            }
            if (i.document1 == null || i.document1 == "") {
              d3.select("#doc-img-0").attr("class", "greyed");
            }
            if (i.document2 == null || i.document2 == "") {
              d3.select("#doc-img-1").attr("class", "greyed");
            }
            if (i.comment[0][i.popup[0]][0] === "") {
              d3.select("#comment-img-0").attr("class", "greyed");
            }
            if (i.comment[0][i.popup[0]][1] === "") {
              d3.select("#comment-img-1").attr("class", "greyed");
            }
            d.selectAll("a.close").on("click", function() {
              d.html("").style("display", "none");
                o.selectAll(".connection.active").classed("active", !1);
                o.selectAll(".connection").style("stroke-width", 2)
              
              researchModeActive = 0;
              researchModeWidth = 600;
            });
            d.selectAll("a.comment").on("click", function() {
              var n =
                r.length == 1 || $(this).attr("data-idx") > 0
                  ? i.comment[0][i.popup[0]][0]
                  : i.comment[0][i.popup[0]][1];
              a.select("textarea").node().value = n;
              a.attr("data-id", i.id)
                .attr(
                  "data-idx",
                  r.length == 1 || $(this).attr("data-idx") > 0 ? "1" : "2"
                )
                .style("display", "inline");
            });
            d.selectAll(".prop").on("click", function() {
              $(this)
                .next()
                .is(":visible")
                ? ($(this)
                    .next()
                    .hide(),
                  $(this)
                    .find("span")
                    .html("+"))
                : ($(this)
                    .next()
                    .show(),
                  $(this)
                    .find("span")
                    .html("-"));
            });
            $(".popup > div").resizable({
              handles: "e",
              resize: function(n, t) {
                var i = $(this).attr("data-id");
                $(".popup > div").each(function() {
                  $(this).attr("data-id") != i &&
                    $(this).css("width", t.size.width + "px");
                  if (researchModeActive === 1) {
                    researchModeWidth = t.size.width;
                  }
                });
              }
            });
          } else {
            d.html("").style("display", "none");
          }

          // end of copy-pasted
        });

      function zoomFunction() {
        var element = document.querySelector("svg");
        element.style.zoom = sval3;
        d3.select("svg")
          .style("transform-origin", "top left")
          .style("-moz-transform", function() {
            return "scale(" + sval3 * 100 + "%)";
          })
          .style("-moz-transform-origin", "top left");

        if (sval3 <= 1) {
          d3.select("svg").attr(
            "transform",
            "translate(" + (sval3 - 1) * -400 + ",0)"
          );
        } else {
          d3.select("svg").attr(
            "transform",
            "translate(" + (sval3 - 1) * -60 + ",0)"
          );
        }
      }

      /*

      BOX MENU DEFINITION:

      */

      function boxmenuNEW(v, boxX, boxY) {
        boxmenu_y = +boxY - 10;
        if (v.mainCol === 1) {
          boxmenu_x = +boxX + 220;
        } else {
          boxmenu_x = +boxX - 170;
        }

        boxmenu_height = 110;
        boxmenu_width = 130;
        boxmenuSize = 16;
        boxmenuSpacing = 8;

        d3.selectAll("#box-menu-svg").remove();

        var boxMenuSVG = bm
          .append("svg")
          .style("top", boxmenu_y + "px")
          .style("left", boxmenu_x + "px")
          .style("position", "fixed")
          .attr("class", "box-menu-svg")
          .attr("id", "box-menu-svg")
          .attr("height", boxmenu_height)
          .attr("width", boxmenu_width)
          .attr("x", boxmenu_x)
          .attr("y", boxmenu_y)
          .append("g")
          .attr(
            "transform",
            "translate(" + boxmenu_width / 2 + "," + boxmenu_height / 2 + ")"
          );

        boxMenuSVG
          .append("rect")
          .attr("height", boxmenu_height)
          .attr("width", boxmenu_width)
          .attr("x", -boxmenu_width / 2)
          .attr("y", -boxmenu_height / 2)
          .attr("fill", "white");

        boxMenuSVG
          .append("rect")
          .attr("height", boxmenu_height - 20)
          .attr("width", boxmenu_width - 20)
          .attr("x", -boxmenu_width / 2 + 10)
          .attr("y", -boxmenu_height / 2 + 10)
          .attr("fill", "none")
          .style("stroke", "#c5c5c5")
          .style("stroke-width", "1px");

        var box_menu_items = boxMenuSVG
          .selectAll("box-menu-legend")
          .data(data.box_menu.border_color)
          .enter()
          .append("g")
          .attr("class", "box-menu-legend")
          .attr("transform", function(d, i) {
            var height = boxmenuSize + boxmenuSpacing;
            var horz = i * height - 45;
            var vert = -20;
            return "translate(" + horz + "," + vert + ")";
          });

        box_menu_items
          .append("rect")
          .attr("fill", function(d) {
            return d;
          })
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", boxmenuSize)
          .attr("height", boxmenuSize)
          .attr("rx", 1)
          .attr("ry", 1)
          .on("click", function(d) {
            d3.select("#box-" + v.id).style("stroke", d);
          });

        boxMenuSVG
          .append("text")
          .text("Border:")
          .attr("x", -45)
          .attr("y", -27)
          .style("font-size", "12px");

        /* boxMenuSVG
          .append("text")
          .text("x")
          .attr("x", 40)
          .attr("y", -28)
          .style("font-size", "14px")
          .style("cursor", "pointer")
          .on("click", function() {
            d3.selectAll("#box-menu-svg").remove();
          }); */

                  boxMenuSVG
          .append("image")
          .attr("href", "close_icon.png")
          .attr("x", 42)
          .attr("y", -40)
          .style("font-size", "14px")
          .style("cursor", "pointer")
          .on("click", function() {
            d3.selectAll("#box-menu-svg").remove();
          });

        var box_menu_items2 = boxMenuSVG
          .selectAll("box-menu-legend")
          .data(data.box_menu.background_color)
          .enter()
          .append("g")
          .attr("class", "box-menu-legend")
          .attr("transform", function(d, i) {
            var height = boxmenuSize + boxmenuSpacing;
            var horz = i * height - 45;
            var vert = 20;
            return "translate(" + horz + "," + vert + ")";
          });

        box_menu_items2
          .append("rect")
          .attr("fill", function(d) {
            return d;
          })
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", boxmenuSize)
          .attr("height", boxmenuSize)
          .on("click", function(d) {
            d3.select("#box-" + v.id).style("fill", d);
          });

        boxMenuSVG
          .append("text")
          .text("Background:")
          .attr("x", -45)
          .attr("y", 12)
          .style("font-size", "12px");

        boxMenuElement = d3.select("#box-menu-svg");
        boxMenuElementWithContent = d3.selectAll(
          "#box-menu-svg, #box-menu-svg *"
        );
      }

      function legend() {
        var t = "";
        t += "<div>";
        t += "<table class='legend-table'>";
        t += "<tr>";
        data.legend.forEach(function(v) {
          t +=
            "<td class='legend-header' id='legend-id-" +
            v.id +
            "'>" +
            v.tooltip +
            "<\/td>";
          t += "<td>" + v.explanation + "<\/td><\/tr>";
        });
        t += "<\/table>";
        t += "<\/div>";

        if (t.length > 0) {
          legend_container.html(t).style("display", "inline");
        } else {
          legend_container.html("").style("display", "none");
        }
        data.legend.forEach(function(v) {
          d3.select("#legend-id-" + v.id).style("color", v.color);
        });
      }
      $(".popup-comment > div").resizable({
        handles: "e, s, se",
        minHeight: 90,
        minWidth: 130,
        resize: function(n, t) {
          $(this).css("width", t.size.width + "px");
          d3.select("#popup-comment-textarea")
            .style("width", t.size.width - 40 + "px")
            .style("height", t.size.height - 65 + "px");
        }
      });

      $(".popup-comment > div").draggable({
        start: function() {
          $(".popup-comment > div").css("right", "auto");
        }
      });

      $(".popup").draggable({
        start: function() {
          $(".popup").css("right", "auto");
        }
      });
      $(".legend-tooltip").draggable({
        start: function() {
          $(".legend-tooltip").css("right", "auto");
        }
      });
      $(".box-menu-tooltip").draggable({
        start: function() {
          $(".box-menu-tooltip").css("right", "auto");
        }
      });
      $(".popup-comment .close").click(function() {
        a.style("display", "none");
        a_bg.style("display", "none");
      });
      $(".popup-comment .save").click(function() {
        var i = a.attr("data-id"),
          t = data.connection.filter(function(n) {
            return n.id == i;
          })[0];
        a.attr("data-idx") == "1"
          ? (t.note1 = a.select("textarea").node().value)
          : (t.note2 = a.select("textarea").node().value);
        a.style("display", "none");
        a_bg.style("display", "none");
      });
      $(window).scroll(function() {
        closeBoxMenu();
      });
      var menuToggle = 1;
      $("#menu-toggle").click(function() {
        $("#menu-contents").toggle();
        if (menuToggle === 1) {
          menuToggle = 0;
          d3.select("#menu-toggle")
            .attr("class", "ui-icon ui-icon-triangle-1-e")
            .style("left", "14px");
          r.attr(
            "transform",
            "translate(" + (u.left - 180) + "," + u.top + ")"
          );
          o.attr(
            "transform",
            "translate(" + (u.left - 180) + "," + u.top + ")"
          );
          ot.attr("transform", "translate(" + (u.left - 180) + ",0)");
          l.style("width", "10px");
        } else {
          menuToggle = 1;
          d3.select("#menu-toggle")
            .attr("class", "ui-icon ui-icon-close")
            .style("left", "169px");
          r.attr("transform", "translate(" + u.left + "," + u.top + ")");
          o.attr("transform", "translate(" + u.left + "," + u.top + ")");
          ot.attr("transform", "translate(" + u.left + ",0)");
          l.style("width", "200px");
        }
      });
    });
  </script>
</html>
